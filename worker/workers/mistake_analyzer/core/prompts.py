"""
Prompt 模板模块
包含所有 LLM 提示词模板
"""
from typing import Optional, Dict, List


# ============= OCR 题目提取 Prompt =============

def get_ocr_system_prompt() -> str:
    """获取 OCR 识别的系统提示词"""
    return """你是专业的题目 OCR 识别专家，精确提取题目文字并识别学科。

**核心要求：**
1. **准确提取**：逐字逐句识别，不遗漏不添加，忽略手写痕迹
2. **公式精确**：数学、物理、化学公式必须用 LaTeX，保持原题结构
3. 行内公式：\( ... \)，独立公式：\[ ... \]（独立成行）
4. 识别完整公式：分数、根号、积分、求和、矩阵等
5. 分段标记格式，LaTeX 直接书写，不转义"""


def build_user_feedback_section(
    user_feedback: Optional[str],
    previous_result: Optional[Dict]
) -> str:
    """构建用户反馈部分"""
    if user_feedback and previous_result:
        prev_content = previous_result.get('content', '无')
        prev_type = previous_result.get('type', '无')
        prev_subject = previous_result.get('subject', '无')
        prev_options = previous_result.get('options', [])
        prev_options_text = '\n'.join(prev_options) if prev_options else '无'
        
        return f"""
🚨🚨🚨 **重要：用户反馈（上次识别出现了错误）** 🚨🚨🚨

**上次你识别的结果：**
- 题目类型：{prev_type}
- 学科：{prev_subject}
- 题目内容：
{prev_content}
- 选项：
{prev_options_text}

**用户指出的错误：**
{user_feedback}

❗❗❗ **请仔细对比上次的识别结果和用户反馈，找出错误在哪里，这次务必修正！** ❗❗❗

---
"""
    elif user_feedback:
        return f"""
🚨🚨🚨 **重要：用户反馈（识别出现了错误）** 🚨🚨🚨

**用户指出的问题：**
{user_feedback}

❗❗❗ **请务必特别注意上述问题，优先修正这些错误！** ❗❗❗

---
"""
    return ""


def build_multi_image_hint(image_count: int) -> str:
    """构建多图提示"""
    if image_count > 1:
        return f"""**重要提示：这是一道跨页题目，共 {image_count} 张图片！**
- 图片按顺序展示了题目的不同部分（可能是题目、图表、选项分布在不同页）
- 请综合所有图片的内容，整合为一道完整的题目
- 所有页面的内容都属于同一道题，请完整提取

"""
    return ""


def get_ocr_user_prompt(
    image_count: int,
    multi_image_hint: str,
    user_feedback_section: str
) -> str:
    """获取 OCR 识别的用户提示词"""
    image_desc = f'这道跨页题目（共 {image_count} 张图片）' if image_count > 1 else '这张题目图片'
    
    return rf"""请识别{image_desc}，提取信息。

{multi_image_hint}**要提取的内容：**
1. **题目内容**：转换为 Markdown + LaTeX 格式
   - 所有公式用 LaTeX：变量、表达式、方程式等
   - 行内公式：\( ... \)
   - 独立公式：\[ ... \]（独立成行）
   - 保留原始结构和段落

2. **题目类型**：choice/fillBlank/shortAnswer/essay

3. **选项**（仅选择题）：每行一个选项，公式也用 LaTeX

4. **学科**：math/physics/chemistry/biology/chinese/english/history/geography/politics

5. **图片位置**（重要）：如果题目中包含图表、函数图像、几何图形、实验装置图等，请标记其位置。

**返回格式（分段标记，不要用代码块包裹）：**

##TYPE##
题目类型

##SUBJECT##
学科代码

##CONTENT##
题目内容（Markdown + LaTeX，LaTeX 公式直接书写，不需要转义）

##OPTIONS##
选项1
选项2
...

##PIC##
框选题目中的图片位置（如果没有图片留空）
[image_index] <bbox>x1 y1 x2 y2</bbox>

##END##

**示例1 - 选择题（数学）：**

##TYPE##
choice

##SUBJECT##
math

##CONTENT##
已知 \( m \)、\( n \) 是方程 \( x^2 + 2020x + 7 = 0 \) 的两个根，则 \( (m^2 + 2019m + 6)(n^2 + 2021n + 8) \) 的值为（）

##OPTIONS##
A. 1
B. 2
C. 3
D. 4

##PIC##

##END##

**示例2 - 填空题（物理）：**

##TYPE##
fillBlank

##SUBJECT##
physics

##CONTENT##
质量为 \( m \) 的物体受力 \( F \)，根据牛顿第二定律 \( F = ma \)，则加速度 \( a \) = ______。

##OPTIONS##

##PIC##
[1] <bbox>100 100 500 500</bbox>

##END##

**示例3 - 解答题（数学）：**

##TYPE##
shortAnswer

##SUBJECT##
math

##CONTENT##
计算定积分：

\[
\int_0^1 x^2 \, dx
\]

请写出详细步骤。

##OPTIONS##

##PIC##

##END##

**示例4 - 选择题（化学）：**

##TYPE##
choice

##SUBJECT##
chemistry

##CONTENT##
下列转化中，能一步实现的是（）

##OPTIONS##
A. \( \text{{Na}} \rightarrow \text{{Na}}_2\text{{O}}_2 \)
B. \( \text{{Cl}}_2 \rightarrow \text{{FeCl}}_3 \)
C. \( \text{{SO}}_3 \rightarrow \text{{Na}}_2\text{{SO}}_4 \)
D. \( \text{{Fe}}_2\text{{O}}_3 \rightarrow \text{{Fe(OH)}}_3 \)

##PIC##

##END##

**LaTeX 常用语法：**
- 分数：\frac{{a}}{{b}}
- 上标：x^2, x^{{n+1}}
- 下标：x_i, a_{{ij}}
- 根号：\sqrt{{x}}, \sqrt[3]{{x}}
- 积分：\int_a^b
- 求和：\sum_{{i=1}}^n
- 希腊字母：\alpha, \beta, \theta, \pi
- 运算符：\times, \div, \pm, \leq, \geq
- 矩阵：\begin{{bmatrix}} ... \end{{bmatrix}}
- **化学式**（重要！）：使用 \text{{}} 包裹化学元素和化合物
  * 单质：\text{{Na}}, \text{{Cl}}_2
  * 化合物：\text{{Na}}_2\text{{O}}_2, \text{{FeCl}}_3, \text{{Na}}_2\text{{SO}}_4
  * 带括号：\text{{Fe(OH)}}_3, \text{{Ca(NO}}_3\text{{)}}_2
  * 反应箭头：\rightarrow, \leftarrow, \rightleftharpoons

**重要：**
- 标记符号必须独占一行
- 行内公式用 \( ... \)，块级公式用 \[ ... \]
- LaTeX 公式直接书写，不需要转义反斜杠
- **化学式必须用 \text{{}} 包裹**，确保化学元素符号正确显示
- OPTIONS 部分如果是非选择题，留空即可
- PIC 部分：如果题目包含重要的几何图形、函数图像、物理情景图、化学实验装置图等，请检测其位置。
  * 格式：[image_index] <bbox>x1 y1 x2 y2</bbox>
  * image_index：图片序号（从1开始），对应输入的第几张图片
  * 坐标范围：0-1000（归一化到1000*1000的比例坐标）
  * x1, y1 是左上角坐标，x2, y2 是右下角坐标
  * 如果有多张图表，每行一个
  * 如果题目没有图片，或图片仅仅是装饰性的，PIC 部分留空
  * 如果题目图片带有说明文字，如“图-xx”或“图-xx-xx”等，请一并框选图片和说明文字

{user_feedback_section}"""


# ============= 知识点分析 Prompt =============

def get_knowledge_points_system_prompt() -> str:
    """获取知识点分析的系统提示词"""
    return """你是学科知识点分析专家，专注于精确识别题目的考点。

核心原则：
- 必须从提供的模块列表中选择
- **优先使用已有知识点**：如果用户已经有相同或相近的知识点，直接使用，避免创建重复或相似的知识点
- **知识点要精确**：使用标准学术术语，避免模糊表达
- 区分题目角色（category）和知识点重要性（importance）

分析要点：
1. **模块选择**：选择题目主要考查内容所在的模块（通常1个，综合题可能2个）
2. **知识点提取**（关键！）：
   - **首先检查已有知识点列表**：如果题目考查的内容在用户已有知识点中存在，直接使用该知识点名称
   - 只有当确实是新的知识点时，才创建新知识点
   - 必须精确、具体，如"一元二次方程判别式"而非"方程"
   - 避免过度概括（太宽泛）或过度细分（太琐碎）
   - 通常1-3个知识点，主要考点1-2个
   - **防止重复**：避免创建与已有知识点含义相同但表述略有不同的知识点
3. **category（题目角色）**：
   - primary：这道题的主要考点，直接考查的核心内容
   - secondary：次要考点，间接涉及的内容
   - related：相关但不直接考查的内容
4. **importance（知识点重要性）**：
   - high：考试高频考点，核心重点知识
   - basic：基础必会内容，其他知识的前置
   - normal：普通考点
5. **解题提示**（核心！）：
   - 分两部分：【本题思路点拨】+【方法论】
   - **本题思路点拨**：用温和、启发的语气点拨思考方向
     * **重要**：只做思维启发和方向指引，不给出具体解题步骤（避免计算错误）
     * **必须包含**："为什么会想到这个思路"的思维启发
     * 点明关键突破口、核心思想、需要注意的地方
     * 可以提示用哪些公式或方法，但不展开具体计算
   - **方法论**：通俗易懂地总结这类题的通用方法、重点、易错点
     * 用清晰的语言，适当使用比喻，但不要过于幼稚
     * 语气要鼓励、积极，让学生感到可以掌握
   - 可使用 LaTeX 公式说明概念
   - 目标：启发学生的思维方式，让学生自己去思考和尝试，而不是照搬步骤"""


def build_modules_hint(modules_text: str) -> str:
    """构建模块列表提示"""
    if modules_text:
        return f"""
**可用模块列表（必须从中选择）：**
{modules_text}"""
    return "\n**注意**：系统暂无模块数据，请使用\"未分类\"。"


def build_existing_kp_hint(knowledge_points_text: str) -> str:
    """构建已有知识点提示"""
    if knowledge_points_text:
        return f"""
**用户已有的知识点（优先使用这些，避免重复）：**
{knowledge_points_text}

⚠️ **重要**：提取知识点时，请先检查上面的已有知识点列表。如果题目考查的内容与已有知识点相同或相近，请直接使用已有的知识点名称，不要创建新的重复知识点。"""
    return ""


def get_knowledge_points_user_prompt(
    subject_chinese: str,
    content: str,
    available_modules_hint: str,
    existing_kp_hint: str
) -> str:
    """获取知识点分析的用户提示词"""
    return rf"""分析这道{subject_chinese}题目，提取模块、知识点和解题提示。

**题目：**
{content}
{available_modules_hint}
{existing_kp_hint}

**返回格式（分段标记，不要用代码块）：**

##MODULES##
模块1
模块2
...

##KNOWLEDGE_POINTS##
知识点名|模块名|category|importance
知识点名|模块名|category|importance
...

##SOLVING_HINT##
解题提示（markdown 格式，可包含 LaTeX）

##END##

**字段说明：**
1. **MODULES**：只填模块名（不含括号描述），必须从上面列表中选择
2. **KNOWLEDGE_POINTS**：每行一个，格式为 `知识点名|模块名|category|importance`
   - **知识点名**：
     * **优先使用已有知识点**：如果用户已有知识点中存在相同或相近的知识点，直接使用已有的名称
     * 只有当确实是新知识点时，才填写新的知识点名称
     * 必须精确、具体，如"一元二次方程判别式"而非"方程"
   - **category**（题目中的角色）：primary（主要考点）/ secondary（次要）/ related（相关）
   - **importance**（知识点重要性）：high（高频考点）/ basic（基础）/ normal（普通）
3. **SOLVING_HINT**：分【本题思路点拨】和【方法论】两部分，**语气要温和启发、通俗易懂**
   - **重要原则**：只做思维启发，不给具体解题步骤（避免计算错误）
   - **本题思路点拨**：
     * 必须说明"为什么会想到这个思路"（思维启发）
     * 点明关键突破口、核心思想、需要注意什么
     * 可以提示用哪些公式或方法，但不展开具体步骤
     * 用"关键在于"、"核心思想"、"突破口"等引导性表达
   - **方法论部分**：用清晰语言总结通用方法、重点、易错点，适当使用比喻但不过于口语化
   - 目标：启发思维，引导学生自己思考，而不是给出完整解答

**示例1（一元二次方程判别式）：**

##MODULES##
二次函数

##KNOWLEDGE_POINTS##
一元二次方程判别式|二次函数|primary|high

##SOLVING_HINT##
**【本题思路点拨】**

**从哪入手？** 看到题目中 \( m \)、\( n \) 是方程的根，而要求的式子又包含 \( m^2 + 2019m + 6 \) 这样的二次式，会自然想到：能不能利用"根满足方程"这个性质来简化？

**关键突破口：**
- 题目给出的是方程的根，这提示我们可以用两个性质：韦达定理 + 根满足方程
- 核心思想：观察 \( m^2 + 2019m + 6 \) 与方程 \( x^2 + 2020x + 7 = 0 \) 的系数关系，能否通过巧妙变形，把"根满足方程"这个条件用上？
- 如果能将式子改写成包含 \( m^2 + 2020m + 7 \) 的形式，就可以直接用 \( m^2 + 2020m + 7 = 0 \) 来简化

**思维方向：**
尝试对代数式进行"凑"的变换，让原方程的形式出现，然后利用根的性质将其化为 0，从而大大简化计算。对另一个因式采用同样的思路，最后整体相乘。

---

**【方法论】**

判别式 \( \Delta = b^2 - 4ac \) 是判断方程根情况的工具：
- \( \Delta > 0 \)：两个不等实根
- \( \Delta = 0 \)：两个相等实根
- \( \Delta < 0 \)：无实根

**韦达定理**让我们无需求出具体根值就能处理根的关系式：
- 两根之和：\( x_1 + x_2 = -\frac{{b}}{{a}} \)
- 两根之积：\( x_1 x_2 = \frac{{c}}{{a}} \)

**解题建议**：遇到包含方程根的复杂代数式时，有两个常用技巧：
1. 利用韦达定理建立根之间的关系
2. 利用"根满足方程"的性质进行巧妙代换

掌握这两种方法可以大大简化计算过程。

##END##

**示例2（物理综合题）：**

##MODULES##
力学
运动学

##KNOWLEDGE_POINTS##
牛顿第二定律|力学|primary|high
匀变速直线运动公式|运动学|primary|high
受力分析|力学|secondary|basic

##SOLVING_HINT##
**【本题思路点拨】**

**思路是什么？** 力学和运动学结合题的本质是：力产生加速度，加速度决定运动。所以解题思路自然是"力→加速度→运动"这条主线。

**关键突破口：**
- **第一步思路**：画受力图，这是理解问题的基础。明确物体受到哪些力，每个力的方向如何
- **核心桥梁**：加速度是连接"力"和"运动"的关键。用牛顿第二定律 \( F_{{合}} = ma \) 求出加速度
- **选择工具**：根据题目给的条件和要求，选择合适的运动学公式：
  * 如果涉及时间，用 \( v = v_0 + at \) 或 \( s = v_0 t + \frac{{1}}{{2}}at^2 \)
  * 如果不涉及时间，用 \( v^2 - v_0^2 = 2as \)

**思维方向：**
抓住"加速度"这个桥梁，从受力分析入手，通过牛顿第二定律连接到运动学。注意力的分解和合成，特别是斜面问题。

---

**【方法论】**

力学与运动学综合题的核心解题流程：**力→加速度→运动**

**核心理念**：加速度是连接力和运动的桥梁。必须先通过受力分析求出加速度，再用运动学公式处理运动过程。

**常见易错点**：
1. 受力分析不完整或力的方向标错
2. 忘记将合力分解到运动方向上（对于斜面等问题尤其要注意）
3. 混淆公式的适用条件（这些公式仅适用于匀变速直线运动）

**解题建议**：
- 区分静摩擦力（平衡力）和滑动摩擦力（阻力）
- 遇到复杂受力情况时，建议使用正交分解法，将力分解为水平和竖直两个方向分别处理

##END##

**示例3（函数图像与性质）：**

##MODULES##
函数

##KNOWLEDGE_POINTS##
函数单调性|函数|primary|high
函数图像变换|函数|secondary|normal

##SOLVING_HINT##
**【本题思路点拨】**

**思路是什么？** 函数图像变换本质上是坐标的系统性改变。理解变换规律后，可以通过跟踪关键点的位置变化来确定新图像。

**关键突破口：**
- **核心方法**：找出基础函数的几个关键点（如极值点、零点、拐点），看这些点经过变换后移动到哪里
- **变换规律**：
  * \( y = f(x - a) \) 是平移变换（注意"\( x - a \)"表示向右平移）
  * \( y = f(-x) \) 是对称变换（关于 y 轴对称）
- **变换顺序**：多个变换同时出现时，先处理括号内对 x 的变换，再处理外部对 y 的变换

**思维方向：**
记住口诀"左加右减，上加下减"，但更重要的是理解为什么。通过几个关键点的位置跟踪，就能画出变换后的图像。

---

**【方法论】**

函数图像变换包括平移、对称和伸缩三大类，掌握规律是关键。

**平移变换**：口诀"左加右减，上加下减"
- \( y = f(x - a) \)：向右平移 \( a \) 个单位
- \( y = f(x + a) \)：向左平移 \( a \) 个单位
- \( y = f(x) + b \)：向上平移 \( b \) 个单位

**对称变换**：
- \( y = f(-x) \)：关于 y 轴对称（左右对调）
- \( y = -f(x) \)：关于 x 轴对称（上下翻转）
- \( y = f(|x|) \)：保留 \( x \geq 0 \) 部分，再关于 y 轴对称

**伸缩变换**：
- \( y = af(x) \)：纵向伸缩（\( a > 1 \) 时拉伸，\( 0 < a < 1 \) 时压缩）
- \( y = f(ax) \)：横向伸缩（\( a > 1 \) 时压缩，\( 0 < a < 1 \) 时拉伸）

**解题技巧**：找出函数图像的关键点（如极值点、零点、拐点），通过变换规律确定这些点的新位置，从而得到变换后的图像。

##END##

**示例4（化学实验题）：**

##MODULES##
化学实验
氧化还原反应

##KNOWLEDGE_POINTS##
氧化还原反应配平|氧化还原反应|primary|high
实验安全与操作|化学实验|secondary|basic

##SOLVING_HINT##
**【本题思路点拨】**

**可以想到什么？** 氧化还原反应的本质是电子转移，所以配平的关键在于保证电子守恒——失去的电子数等于得到的电子数。

**关键突破口：**
- **核心原则**：电子守恒，即"升失 = 降得"（化合价升高失去的电子数 = 化合价降低得到的电子数）
- **思路方向**：
  * 先标化合价，找出哪些元素的化合价发生了变化
  * 分清谁是氧化剂（得电子，化合价降低），谁是还原剂（失电子，化合价升高）
  * 用化合价升降法算出电子转移数，然后用最小公倍数让"升失 = 降得"
- **注意环境**：反应介质（酸性or碱性）会影响产物形式，这点要留意

**思维方向：**
抓住"电子守恒"这个核心，先配平化合价变化的物质，再用观察法配平其他物质，最后检查原子守恒和电荷守恒。

---

**【方法论】**

氧化还原反应配平的关键是 **"化合价升降法"** 和 **"电子守恒"**。

**标准步骤**：
1. 标化合价，找变价元素
2. 列出升降电子数
3. 用最小公倍数使 **升失 = 降得**
4. 配平化合价变化的物质系数
5. 用观察法配平其他物质
6. 检查原子守恒

**常见易错点**：
1. 忘记考虑一个分子中有多个相同元素原子时，电子转移数要乘以原子个数
2. 酸性条件下产物是水，碱性条件下是 OH⁻
3. 部分反应中，同一物质既是氧化剂又是还原剂（歧化反应）

**记忆口诀**：升失氧、降得还，氧化剂被还原。

##END##"""

