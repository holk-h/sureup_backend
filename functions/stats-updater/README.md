# Stats Updater - ç»Ÿè®¡æ›´æ–°å™¨

## åŠŸèƒ½æ¦‚è¿°

`stats-updater` æ˜¯ä¸€ä¸ª Appwrite L1 å‡½æ•°ï¼Œé€šè¿‡ç›‘å¬æ•°æ®åº“äº‹ä»¶è‡ªåŠ¨æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆå’ŒçŸ¥è¯†ç‚¹çš„ç»Ÿè®¡æ•°æ®ã€‚

## èŒè´£åˆ†å·¥

ä¸ºäº†é¿å…é‡å¤æ›´æ–°ï¼Œç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªå‡½æ•°è´Ÿè´£ä¸åŒçš„ç»Ÿè®¡æ›´æ–°ï¼š

### 1. **mistake_analyzer** (é”™é¢˜è®°å½•æ—¶)
è´Ÿè´£æ›´æ–°é”™é¢˜ç›¸å…³çš„åŸºç¡€ç»Ÿè®¡ï¼š
- âœ… `totalMistakes` - æ€»é”™é¢˜æ•°
- âœ… `todayMistakes` - ä»Šæ—¥é”™é¢˜æ•°
- âœ… `weekMistakes` - æœ¬å‘¨é”™é¢˜æ•°
- âœ… `weeklyMistakesData` - å‘¨æ•°æ®å›¾è¡¨ (JSON)
- âœ… `activeDays` - æ´»è·ƒå¤©æ•°ï¼ˆå¦‚æœä»Šå¤©é¦–æ¬¡æ´»åŠ¨ï¼‰
- âœ… æ—¶é—´æˆ³ï¼š`lastActiveAt`, `lastResetDate`, `statsUpdatedAt`

### 2. **stats-updater** (æœ¬å‡½æ•°)
è´Ÿè´£æ›´æ–°ä»¥ä¸‹ç»Ÿè®¡ï¼š

#### çŸ¥è¯†ç‚¹ç»Ÿè®¡
- âœ… `mistakeCount` - çŸ¥è¯†ç‚¹é”™é¢˜æ•°
- âœ… `masteredCount` - çŸ¥è¯†ç‚¹æŒæ¡æ•°
- âœ… `lastMistakeAt` - æœ€åé”™é¢˜æ—¶é—´

#### ç»ƒä¹ ç»Ÿè®¡
- âœ… `todayPracticeSessions` - ä»Šæ—¥ç»ƒä¹ æ¬¡æ•°
- âœ… `weekPracticeSessions` - æœ¬å‘¨ç»ƒä¹ æ¬¡æ•°
- âœ… `totalPracticeSessions` - æ€»ç»ƒä¹ æ¬¡æ•°
- âœ… `completedSessions` - å·²å®Œæˆç»ƒä¹ æ¬¡æ•°

#### ç­”é¢˜ç»Ÿè®¡
- âœ… `totalQuestions` - æ€»ç­”é¢˜æ•°
- âœ… `totalCorrectAnswers` - æ€»æ­£ç¡®æ•°

#### å­¦ä¹ è¿›åº¦
- âœ… `masteredMistakes` - å·²æŒæ¡é”™é¢˜æ•°
- âœ… `continuousDays` - è¿ç»­å­¦ä¹ å¤©æ•°
- âœ… `lastPracticeDate` - æœ€åç»ƒä¹ æ—¥æœŸ

## äº‹ä»¶ç›‘å¬

ç›‘å¬ä»¥ä¸‹ 4 ç§æ•°æ®åº“äº‹ä»¶ï¼š

### 1. `mistake_records` åˆ›å»ºäº‹ä»¶
```
databases.*.collections.mistake_records.documents.*.create
```
**è§¦å‘æ—¶æœº**: ç”¨æˆ·è®°å½•æ–°é”™é¢˜æ—¶ï¼ˆç”± mistake_analyzer åˆ†æå®Œæˆåï¼‰

**æ›´æ–°å†…å®¹**:
- å…³è”çŸ¥è¯†ç‚¹çš„ `mistakeCount` + 1
- å…³è”çŸ¥è¯†ç‚¹çš„ `lastMistakeAt` æ›´æ–°

**æ³¨æ„**: ç”¨æˆ·æ¡£æ¡ˆçš„ `totalMistakes` ç­‰å­—æ®µç”± `mistake_analyzer` æ›´æ–°ï¼Œè¿™é‡Œ**ä¸æ›´æ–°**ã€‚

---

### 2. `mistake_records` æ›´æ–°äº‹ä»¶
```
databases.*.collections.mistake_records.documents.*.update
```
**è§¦å‘æ—¶æœº**: é”™é¢˜çŠ¶æ€å˜ä¸º `mastered`ï¼ˆå·²æŒæ¡ï¼‰æ—¶

**åˆ¤æ–­æ¡ä»¶**: `masteryStatus == 'mastered'`

**æ›´æ–°å†…å®¹**:
- å…³è”çŸ¥è¯†ç‚¹çš„ `masteredCount` + 1
- ç”¨æˆ·æ¡£æ¡ˆçš„ `masteredMistakes` + 1

---

### 3. `practice_answers` åˆ›å»ºäº‹ä»¶
```
databases.*.collections.practice_answers.documents.*.create
```
**è§¦å‘æ—¶æœº**: ç”¨æˆ·åœ¨ç»ƒä¹ ä¸­ç­”é¢˜æ—¶

**æ›´æ–°å†…å®¹**:
- ç»ƒä¹ ä¼šè¯çš„ `completedQuestions` + 1
- ç»ƒä¹ ä¼šè¯çš„ `correctQuestions` + 1ï¼ˆå¦‚æœæ­£ç¡®ï¼‰
- ç”¨æˆ·æ¡£æ¡ˆçš„ `totalQuestions` + 1
- ç”¨æˆ·æ¡£æ¡ˆçš„ `totalCorrectAnswers` + 1ï¼ˆå¦‚æœæ­£ç¡®ï¼‰

---

### 4. `practice_sessions` æ›´æ–°äº‹ä»¶ (æ–°å¢)
```
databases.*.collections.practice_sessions.documents.*.update
```
**è§¦å‘æ—¶æœº**: ç»ƒä¹ ä¼šè¯çŠ¶æ€å˜ä¸º `completed`ï¼ˆå·²å®Œæˆï¼‰æ—¶

**åˆ¤æ–­æ¡ä»¶**: `status == 'completed'`

**æ›´æ–°å†…å®¹**:
- æ£€æŸ¥å¹¶é‡ç½®æ¯æ—¥æ•°æ®ï¼ˆå¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼‰
- `todayPracticeSessions` + 1
- `weekPracticeSessions` + 1
- `totalPracticeSessions` + 1
- `completedSessions` + 1
- `lastPracticeDate` æ›´æ–°
- `continuousDays` æ™ºèƒ½è®¡ç®—
- `activeDays` + 1ï¼ˆå¦‚æœä»Šå¤©é¦–æ¬¡æ´»åŠ¨ï¼‰

## æ ¸å¿ƒé€»è¾‘

### 1. è¿ç»­å­¦ä¹ å¤©æ•°è®¡ç®—

```python
def calculate_continuous_days(databases, user_id, profile):
    """
    æ™ºèƒ½è®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°
    
    è§„åˆ™ï¼š
    - å¦‚æœä¸Šæ¬¡ç»ƒä¹ æ˜¯æ˜¨å¤© â†’ è¿ç»­å¤©æ•° + 1
    - å¦‚æœä¸Šæ¬¡ç»ƒä¹ æ˜¯ä»Šå¤© â†’ ä¿æŒä¸å˜
    - å¦‚æœä¸Šæ¬¡ç»ƒä¹ æ›´æ—© â†’ é‡ç½®ä¸º 1
    """
```

**ç¤ºä¾‹**:
- ç”¨æˆ·å‘¨ä¸€ç»ƒä¹ ï¼Œå‘¨äºŒç»ƒä¹  â†’ è¿ç»­ 2 å¤©
- ç”¨æˆ·å‘¨ä¸€ç»ƒä¹ ï¼Œå‘¨ä¸‰ç»ƒä¹  â†’ é‡ç½®ä¸º 1 å¤©
- ç”¨æˆ·å‘¨ä¸€ç»ƒä¹ ä¸¤æ¬¡ â†’ è¿ç»­ 1 å¤©ï¼ˆä¸é‡å¤è®¡ç®—ï¼‰

### 2. æ¯æ—¥æ•°æ®é‡ç½®

```python
# æ£€æŸ¥ lastResetDate æ˜¯å¦æ˜¯ä»Šå¤©
if last_reset_date < today:
    todayPracticeSessions = 0
    lastResetDate = today
```

### 3. æ´»è·ƒå¤©æ•°é€’å¢

```python
# æ£€æŸ¥ lastActiveAt æ˜¯å¦æ˜¯ä»Šå¤©
if last_active_at < today:
    activeDays += 1
```

## æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·å®Œæˆç»ƒä¹ 
    â†“
Flutter æ›´æ–° session.status = 'completed'
    â†“
è§¦å‘ stats-updater (practice_sessions.update äº‹ä»¶)
    â†“
1. æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥æ•°æ®
    â”œâ”€ éœ€è¦ â†’ todayPracticeSessions = 0
    â””â”€ ä¸éœ€è¦ â†’ ç»§ç»­
    â†“
2. é€’å¢ç»ƒä¹ æ¬¡æ•°
    â”œâ”€ todayPracticeSessions + 1
    â”œâ”€ weekPracticeSessions + 1
    â”œâ”€ totalPracticeSessions + 1
    â””â”€ completedSessions + 1
    â†“
3. è®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°
    â”œâ”€ ä¸Šæ¬¡ç»ƒä¹ æ˜¯æ˜¨å¤© â†’ continuousDays + 1
    â”œâ”€ ä¸Šæ¬¡ç»ƒä¹ æ˜¯ä»Šå¤© â†’ ä¿æŒä¸å˜
    â””â”€ ä¸Šæ¬¡ç»ƒä¹ æ›´æ—© â†’ é‡ç½®ä¸º 1
    â†“
4. æ›´æ–°æ´»è·ƒå¤©æ•°ï¼ˆå¦‚æœä»Šå¤©é¦–æ¬¡æ´»åŠ¨ï¼‰
    â””â”€ activeDays + 1
    â†“
5. æ›´æ–°æ—¶é—´æˆ³
    â”œâ”€ lastPracticeDate
    â”œâ”€ lastActiveAt
    â””â”€ statsUpdatedAt
    â†“
å®Œæˆ
```

## ç­”é¢˜ç»Ÿè®¡æµç¨‹

```
ç”¨æˆ·åœ¨ç»ƒä¹ ä¸­ç­”é¢˜
    â†“
Flutter åˆ›å»º practice_answer è®°å½•
    â†“
è§¦å‘ stats-updater (practice_answers.create äº‹ä»¶)
    â†“
1. æ›´æ–°ç»ƒä¹ ä¼šè¯ç»Ÿè®¡
    â”œâ”€ completedQuestions + 1
    â””â”€ correctQuestions + 1 (å¦‚æœæ­£ç¡®)
    â†“
2. æ›´æ–°ç”¨æˆ·ç­”é¢˜ç»Ÿè®¡
    â”œâ”€ totalQuestions + 1
    â””â”€ totalCorrectAnswers + 1 (å¦‚æœæ­£ç¡®)
    â†“
å®Œæˆ
```

## é”™è¯¯å¤„ç†

### 1. çŸ¥è¯†ç‚¹æ›´æ–°å¤±è´¥
- **ç­–ç•¥**: ç»§ç»­å¤„ç†å…¶ä»–çŸ¥è¯†ç‚¹ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
- **æ—¥å¿—**: è®°å½•å¤±è´¥çš„çŸ¥è¯†ç‚¹ ID

### 2. ç”¨æˆ·æ¡£æ¡ˆæ›´æ–°å¤±è´¥
- **ç­–ç•¥**: è®°å½•é”™è¯¯ä½†ä¸æŠ›å‡ºå¼‚å¸¸
- **åŸå› **: ç”¨æˆ·æ¡£æ¡ˆå¯èƒ½ä¸å­˜åœ¨ï¼ˆæ–°ç”¨æˆ·ï¼‰

### 3. ç»ƒä¹ ä¼šè¯æ›´æ–°å¤±è´¥
- **ç­–ç•¥**: è®°å½•é”™è¯¯ä½†ä¸å½±å“ç”¨æˆ·æ¡£æ¡ˆæ›´æ–°
- **æ—¥å¿—**: å®Œæ•´çš„ traceback

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æŸ¥è¯¢
- ä½¿ç”¨ `get_document()` è€Œä¸æ˜¯ `list_documents()`ï¼ˆå½“æœ‰ ID æ—¶ï¼‰
- å¯¹ç”¨æˆ·æ¡£æ¡ˆæŸ¥è¯¢ä½¿ç”¨ `Query.limit(1)`

### 2. æœ€å°æ›´æ–°
- åªæ›´æ–°éœ€è¦æ”¹å˜çš„å­—æ®µ
- é¿å…ä¸å¿…è¦çš„æ•°æ®åº“å†™å…¥

### 3. æ¡ä»¶åˆ¤æ–­
- æ£€æŸ¥ `masteryStatus` æ˜¯å¦ä¸º `mastered` æ‰æ‰§è¡Œæ›´æ–°
- æ£€æŸ¥ `status` æ˜¯å¦ä¸º `completed` æ‰æ‰§è¡Œæ›´æ–°

## é…ç½®å‚æ•°

### ç¯å¢ƒå˜é‡
```bash
APPWRITE_ENDPOINT=https://cloud.appwrite.io/v1
APPWRITE_PROJECT_ID=your_project_id
APPWRITE_API_KEY=your_api_key
APPWRITE_DATABASE_ID=main  # é»˜è®¤å€¼
```

### å‡½æ•°é…ç½®
- **Runtime**: `python-3.9`
- **Specification**: `s-0.5vcpu-512mb`
- **Timeout**: `15` ç§’
- **Scopes**: `databases.read`, `databases.write`

## æ—¥å¿—ç¤ºä¾‹

### ç»ƒä¹ å®Œæˆäº‹ä»¶
```
æ”¶åˆ°äº‹ä»¶: databases.main.collections.practice_sessions.documents.abc123.update
å¤„ç†ç»ƒä¹ ä¼šè¯å®Œæˆäº‹ä»¶
âœ“ é‡ç½®æ¯æ—¥ç»ƒä¹ ç»Ÿè®¡
âœ“ æ›´æ–°ç”¨æˆ·ç»ƒä¹ ç»Ÿè®¡: user123
   - ä»Šæ—¥ç»ƒä¹ : 1
   - æœ¬å‘¨ç»ƒä¹ : 3
   - æ€»ç»ƒä¹ æ¬¡æ•°: 15
   - è¿ç»­å­¦ä¹ : 5å¤©
   - æ´»è·ƒå¤©æ•°: 12
```

### ç­”é¢˜äº‹ä»¶
```
æ”¶åˆ°äº‹ä»¶: databases.main.collections.practice_answers.documents.xyz789.create
å¤„ç†ç­”é¢˜è®°å½•åˆ›å»ºäº‹ä»¶
âœ“ æ›´æ–°ç»ƒä¹ ä¼šè¯ç»Ÿè®¡: session123
âœ“ æ›´æ–°ç”¨æˆ·ç­”é¢˜ç»Ÿè®¡: user123
```

### æŒæ¡äº‹ä»¶
```
æ”¶åˆ°äº‹ä»¶: databases.main.collections.mistake_records.documents.mistake456.update
å¤„ç†é”™é¢˜æŒæ¡äº‹ä»¶
âœ“ æ›´æ–°çŸ¥è¯†ç‚¹æŒæ¡ç»Ÿè®¡: kp001
âœ“ æ›´æ–°çŸ¥è¯†ç‚¹æŒæ¡ç»Ÿè®¡: kp002
âœ“ æ›´æ–°ç”¨æˆ·æŒæ¡ç»Ÿè®¡: user123
```

## æµ‹è¯•åœºæ™¯

### å•å…ƒæµ‹è¯•
1. âœ… é”™é¢˜åˆ›å»º â†’ çŸ¥è¯†ç‚¹ç»Ÿè®¡æ›´æ–°
2. âœ… é”™é¢˜æŒæ¡ â†’ æŒæ¡ç»Ÿè®¡æ›´æ–°
3. âœ… ç­”é¢˜è®°å½• â†’ ç­”é¢˜ç»Ÿè®¡æ›´æ–°
4. âœ… ç»ƒä¹ å®Œæˆ â†’ ç»ƒä¹ ç»Ÿè®¡æ›´æ–°
5. âœ… è¿ç»­å­¦ä¹ å¤©æ•°è®¡ç®—æ­£ç¡®
6. âœ… æ¯æ—¥æ•°æ®é‡ç½®æ­£ç¡®

### é›†æˆæµ‹è¯•
```python
# åœºæ™¯ï¼šç”¨æˆ·å®Œæ•´çš„å­¦ä¹ æµç¨‹
1. ç”¨æˆ·è®°å½•é”™é¢˜ â†’ è§¦å‘ mistake_analyzer â†’ è§¦å‘ stats-updater
2. ç”¨æˆ·å¼€å§‹ç»ƒä¹  â†’ åˆ›å»º practice_session
3. ç”¨æˆ·ç­”é¢˜ â†’ åˆ›å»º practice_answer â†’ è§¦å‘ stats-updater
4. ç”¨æˆ·å®Œæˆç»ƒä¹  â†’ æ›´æ–° session.status â†’ è§¦å‘ stats-updater
5. éªŒè¯æ‰€æœ‰ç»Ÿè®¡æ•°æ®æ­£ç¡®
```

## ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æ¡£æ¡ˆç»Ÿè®¡å­—æ®µè¯´æ˜](../../doc/profile_stats_fields.md)
- [Mistake Analyzer ç»Ÿè®¡æ›´æ–°](../worker/workers/mistake_analyzer/STATS_UPDATE.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../../doc/design/03_data_models.md)

## ç‰ˆæœ¬å†å²

### v2.0 (2024-11-03)
- âœ¨ æ–°å¢ practice_sessions æ›´æ–°äº‹ä»¶ç›‘å¬
- âœ¨ æ·»åŠ ç»ƒä¹ ç»Ÿè®¡æ›´æ–°é€»è¾‘
- âœ¨ æ™ºèƒ½è®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°
- âœ¨ æ·»åŠ æ¯æ—¥æ•°æ®é‡ç½®é€»è¾‘
- âœ¨ æ·»åŠ æ´»è·ƒå¤©æ•°æ›´æ–°
- ğŸ”§ ä¼˜åŒ–èŒè´£åˆ†å·¥ï¼Œé¿å…ä¸ mistake_analyzer é‡å¤
- ğŸ“ å®Œå–„æ–‡æ¡£å’Œæ³¨é‡Š

### v1.0 (ä¹‹å‰)
- åŸºç¡€çš„çŸ¥è¯†ç‚¹å’Œç”¨æˆ·ç»Ÿè®¡æ›´æ–°
- ç›‘å¬ mistake_records å’Œ practice_answers äº‹ä»¶

## æ³¨æ„äº‹é¡¹

âš ï¸ **é¿å…é‡å¤æ›´æ–°**: é”™é¢˜ç›¸å…³çš„åŸºç¡€ç»Ÿè®¡ï¼ˆtotalMistakes, todayMistakes ç­‰ï¼‰ç”± `mistake_analyzer` æ›´æ–°ï¼Œæœ¬å‡½æ•°**ä¸åº”**æ›´æ–°è¿™äº›å­—æ®µã€‚

âš ï¸ **æ¯å‘¨æ•°æ®é‡ç½®**: `weekMistakes` å’Œ `weekPracticeSessions` çš„é‡ç½®åº”è¯¥ç”± `daily-task-scheduler` å®šæ—¶ä»»åŠ¡å¤„ç†ï¼Œä¸åœ¨äº‹ä»¶è§¦å‘æ—¶å¤„ç†ã€‚

âš ï¸ **æ—¶åŒºä¸€è‡´æ€§**: æ‰€æœ‰æ—¶é—´æˆ³ä½¿ç”¨ UTC æ—¶é—´ï¼Œæ—¥æœŸæ¯”è¾ƒä½¿ç”¨ `.date()` å¯¹è±¡ã€‚

âš ï¸ **å¹‚ç­‰æ€§**: åŒä¸€ä¸ªäº‹ä»¶å¯èƒ½è¢«è§¦å‘å¤šæ¬¡ï¼Œéœ€è¦ç¡®ä¿ç»Ÿè®¡æ•°æ®çš„æ­£ç¡®æ€§ã€‚å¯¹äºè®¡æ•°ç±»å­—æ®µï¼ˆ+1ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚

